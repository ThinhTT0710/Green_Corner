@model List<PointTransactionWithUserDTO>

@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Lịch sử thưởng điểm";
}

<section class="content-main">
    <div class="row">
        <div class="col-12">
            <div class="content-header">
                <h2 class="content-title mb-4">@ViewData["Title"]</h2>
            </div>

            @if (TempData["error"] != null)
            {
                <div class="alert alert-danger">@TempData["error"]</div>
            }

            <!-- Search & Page Size -->
            <div class="row mb-3">
                <div class="col-md-4 mb-2">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm theo tên, email hoặc loại giao dịch..." />
                </div>
                <div class="col-md-2 mb-2">
                    <select id="itemsPerPage" class="form-select">
                        <option value="10">Hiển thị 10</option>
                        <option value="20">Hiển thị 20</option>
                        <option value="all">Tất cả</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Họ tên</th>
                                    <th>Email</th>
                                    <th>Số điểm</th>
                                    <th>Loại</th>
                                    <th>Thời gian</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTable">
                                @if (!Model.Any())
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Không có dữ liệu giao dịch điểm.</td>
                                    </tr>
                                }
                                else
                                {
                                    foreach (var item in Model)
                                    {
                                        <tr class="point-row"
                                            data-name="@item.User.FullName?.ToLower()"
                                            data-email="@item.User.Email?.ToLower()"
                                            data-type="@item.Transaction.Type?.ToLower()">
                                            <td width="37%">
                                                <a asp-controller="Admin" asp-action="UserDetail" asp-route-userId="@item.User.ID" class="itemside">
                                                    <div class="left">
                                                        <img src="@item.User.Avatar" class="img-sm img-avatar" alt="Userpic" />
                                                    </div>
                                                    <div class="info pl-3">
                                                        <h6 class="mb-0 title">@item.User.FullName</h6>
                                                        <small class="text-muted">#@item.User.ID</small>
                                                    </div>
                                                </a>
                                            </td>
                                            <td>@item.User.Email</td>
                                            <td>@item.Transaction.Points</td>
                                            <td>
                                                @if (item.Transaction.Type == "Thưởng")
                                                {
                                                    <span class="badge rounded-pill badge-soft-success">@item.Transaction.Type</span>
                                                }
                                                else
                                                {
                                                    <span class="badge rounded-pill badge-soft-danger">@item.Transaction.Type</span>
                                                }
                                            </td>
                                            <td>@item.Transaction.CreatedAt?.ToString("HH:mm:ss dd/MM/yyyy")</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-area mt-3" id="pagination"></div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            function filterTransactions() {
                let keyword = $('#searchInput').val().toLowerCase();
                let rows = $('.point-row');

                rows.hide().filter(function () {
                    let name = $(this).data('name');
                    let email = $(this).data('email');
                    let type = $(this).data('type');

                    return !keyword || name?.includes(keyword) || email?.includes(keyword) || type?.includes(keyword);
                }).show();

                paginate();
            }

            function paginate() {
                let perPage = $('#itemsPerPage').val();
                let items = $('.point-row:visible');
                let total = items.length;

                if (perPage === "all") {
                    items.show();
                    $('#pagination').html('');
                    return;
                }

                let limit = parseInt(perPage);
                let totalPages = Math.ceil(total / limit);
                let paginationHtml = '';

                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<button class="btn btn-sm btn-outline-success me-1 page-btn" data-page="${i}">${i}</button>`;
                }

                $('#pagination').html(paginationHtml);
                items.hide().slice(0, limit).show();

                $('.page-btn').click(function () {
                    let page = parseInt($(this).data('page'));
                    let start = (page - 1) * limit;
                    let end = start + limit;

                    items.hide().slice(start, end).show();
                });
            }

            $('#searchInput, #itemsPerPage').on('input change', filterTransactions);
            filterTransactions();
        });
    </script>
}
