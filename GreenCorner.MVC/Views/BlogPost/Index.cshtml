@model List<GreenCorner.MVC.ViewModels.BlogWithAuthorViewModel>
@{
    ViewData["Title"] = "Góc chia sẻ";
    var favoriteBlogIds = ViewBag.FavoriteBlogIds as List<int> ?? new();
    string actionName = ViewContext.RouteData.Values["action"]?.ToString();
    bool isFavoritePage = actionName == "MyFavoriteBlogs";
}

<main class="main">
    <div class="page-header mt-30 mb-75">
        <div class="container">
            <div class="archive-header">
                <div class="row align-items-center">
                    <div class="col-xl-3">
                        <h1 class="mb-15">@ViewData["Title"]</h1>
                        <div class="breadcrumb">
                            <a href="/" rel="nofollow"><i class="fi-rs-home mr-5"></i>Trang chủ</a>
                            <span></span> Blog & Tin tức
                        </div>
                    </div>
                    <div class="col-xl-9 text-end d-none d-xl-block">
                        <ul class="tags-list">
                            <li class="hover-up"><a asp-action="CreateBlog"><i class="fi-rs-edit mr-10"></i>Tạo Bài Viết</a></li>
                            <li class="hover-up"><a asp-action="MyFavoriteBlogs"><i class="fi-rs-heart mr-10"></i>Bài Viết Yêu Thích</a></li>
                            <li class="hover-up mr-0"><a asp-action="MyPendingBlogs"><i class="fi-rs-clock mr-10"></i>Bài Viết Của Tôi</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page-content mb-50">
        <div class="container">
            <div class="row">
                <div class="col-xl-8 col-lg-10 col-md-12 m-auto">
                    <div class="shop-product-fillter mb-30 d-flex justify-content-center">
                        <input type="text" id="searchInput" class="form-control w-75 text-center" placeholder="Tìm theo tiêu đề, tác giả hoặc ngày (dd/MM/yyyy)..." />
                    </div>

                    <div class="loop-grid loop-big">
                        <div class="row" id="blogContainer">
                            @if (Model != null && Model.Any())
                            {
                                foreach (var item in Model)
                                {
                                    var blog = item.Blog;
                                    var author = item.Author;
                                    bool isFavorited = favoriteBlogIds.Contains(blog.BlogId);
                                    <article class="first-post mb-30 hover-up animated blog-item">
                                        <div class="position-relative overflow-hidden">
                                            <div class="post-thumb border-radius-15">
                                                @{
                                                    var thumbnail = blog.ThumbnailUrl?.Split('&').FirstOrDefault() ?? "/imgs/default.jpg";
                                                }
                                                <a asp-action="ViewBlogDetail" asp-route-id="@blog.BlogId">
                                                    <img class="border-radius-15" src="@thumbnail" alt="ảnh blog" style="width: 989px; height: 431px; object-fit: cover;" />
                                                </a>
                                            </div>
                                        </div>
                                        <div class="entry-content">
                                            <h2 class="post-title mb-20">
                                                <a asp-action="ViewBlogDetail" asp-route-id="@blog.BlogId">@blog.Title</a>
                                            </h2>
                                            <p class="post-exerpt font-medium text-muted mb-30">
                                                @((blog.Content?.Length > 100 ? blog.Content.Substring(0, 100) + "..." : blog.Content))
                                            </p>
                                            <div class="entry-meta meta-1 mb-30 font-sm text-muted">
                                                <span class="blog-author"><i class="fi-rs-user"></i> @(author?.FullName ?? "Không rõ")</span>
                                                <span class="ml-20 blog-date"><i class="fi-rs-calendar"></i> @blog.CreatedAt?.ToString("dd/MM/yyyy")</span>
                                                <span class="ml-20">
                                                    <button class="btn-favorite @(isFavorited ? "favorited" : "")"
                                                            style="background: none; border: none; padding: 0;"
                                                            data-blogid="@blog.BlogId"
                                                            title="Yêu thích">
                                                        <i class="bi @(isFavorited ? "bi-heart-fill text-danger" : "bi-heart text-dark")"
                                                           id="fav-icon-@blog.BlogId"></i>
                                                    </button>
                                                </span>
                                            </div>
                                            <div>
                                                <a asp-action="ViewBlogDetail" asp-route-id="@blog.BlogId" class="btn btn-sm">Xem chi tiết<i class="fi-rs-arrow-right ml-10"></i></a>
                                            </div>
                                        </div>
                                    </article>
                                }
                            }
                            else
                            {
                                <p class="text-muted text-center">Không có bài viết nào.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Toggle yêu thích
            $(".btn-favorite").click(function (e) {
                e.preventDefault();
                var button = $(this);
                var blogId = button.data("blogid");

                $.ajax({
                    url: '/BlogPost/ToggleFavorite',
                    type: 'POST',
                    data: { blogId: blogId },
                    success: function (response) {
                        if (response.isSuccess) {
                            var icon = button.find("i");
                            if (icon.hasClass("bi-heart")) {
                                icon.removeClass("bi-heart text-dark").addClass("bi-heart-fill text-danger");
                            } else {
                                icon.removeClass("bi-heart-fill text-danger").addClass("bi-heart text-dark");
                            }
                        } else {
                            alert("Thao tác thất bại: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Đã xảy ra lỗi.");
                    }
                });
            });

            // Tìm kiếm
            $("#searchInput").on("input", function () {
                var value = $(this).val().toLowerCase();

                $(".blog-item").each(function () {
                    var title = $(this).find(".post-title").text().toLowerCase();
                    var author = $(this).find(".blog-author").text().toLowerCase();
                    var date = $(this).find(".blog-date").text().toLowerCase();

                    $(this).toggle(
                        title.includes(value) ||
                        author.includes(value) ||
                        date.includes(value)
                    );
                });
            });
        });
    </script>
}
